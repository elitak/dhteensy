#include <avr/pgmspace.h>
#include <stdio.h>
#include "usb_keyboard_debug.h"
#include <avr/io.h>
#include "ports.h"

void debug_print(char *string) {
    //FIXME this table is very much incomplete. only a-zA-Z0-9,spc,newline are working
    // This table maps ascii codes to usb key codes.
    uint8_t table[] = {
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x28, 0x00, 0x00, 0x00, 0x00, 0x00, 
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
        0x2C, 0x00, 0x00, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 

        // +0x40
        0x27, 0x1E, 0x1F, 0x20, 0x21, 0x22, 0x23, 0x24, 0x25, 0x26, 0x27, 0x00, 0x33, 0x00, 0x00, 0x00, 

        // +0x40
        0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x09, 0x0A, 0x0B, 0x0C, 0x0D, 0x0E, 0x0F, 0x10, 0x11, 0x12,
        0x13, 0x14, 0x15, 0x16, 0x17, 0x18, 0x19, 0x1A, 0x1B, 0x1C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        // +0x60
        0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x09, 0x0A, 0x0B, 0x0C, 0x0D, 0x0E, 0x0F, 0x10, 0x11, 0x12,
        0x13, 0x14, 0x15, 0x16, 0x17, 0x18, 0x19, 0x1A, 0x1B, 0x1C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    };
    for (char *c = string; *c;) {
        uint8_t mod = 0;
        uint8_t b = *c++;
        keyboard_modifier_keys = 0;
        if (b >= 'A' && b <= 'Z') {
            mod |= KEY_SHIFT;
        // HACK ill need to keep a list of all shifted positions?? seems tedious. how does usb send special chars?
        } else if (b == 0x23) { //hash
            mod = KEY_SHIFT;
        }
        usb_keyboard_press(table[b], mod);
    }
}

#define BUFLEN 128

void debug_dump(void) {
    uint8_t b;
    char s[BUFLEN];

    snprintf(s, BUFLEN, "#port1 (keys) is\n"); debug_print(s);
    for (int selector=0; selector<14; selector++) {
        b = scan_line(selector);
        snprintf(s, BUFLEN, "#  0x%.1x\n", b); debug_print(s);
    }

    b = port0_read();
    snprintf(s, BUFLEN, "#port0 is 0x%.2x\n", b); debug_print(s);

    b = port2_read();
    snprintf(s, BUFLEN, "#port2 is 0x%.2x\n", b); debug_print(s);


    snprintf(s, BUFLEN, "#pinE1 is 0b%d\n", !!(PINE & 1<<1)); debug_print(s);
    snprintf(s, BUFLEN, "#pinE6 is 0b%d\n", !!(PINE & 1<<6)); debug_print(s);
    snprintf(s, BUFLEN, "#pinC is 0x%.2x\n", PINC); debug_print(s);
    snprintf(s, BUFLEN, "#pinD6 is 0b%d\n", rst_read()); debug_print(s);
}
